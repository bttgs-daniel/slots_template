<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
    <title>{{{ PRODUCT_NAME }}}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-orientations" content="landscape">
    <link rel="manifest" href="manifest.json">
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      
      html {
        height: 100%;
        height: -webkit-fill-available;
      }
      
      body {
        height: 100%;
        height: -webkit-fill-available;
        overflow: hidden;
        background: #1a1a2e;
        position: fixed;
        width: 100%;
        top: 0;
        left: 0;
      }
      
      #gameContainer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #1a1a2e;
      }
      
      #gameCanvas {
        background: #231F20;
        display: block;
        cursor: default;
      }
      
      /* Landscape orientation - fit game properly */
      @media screen and (orientation: landscape) {
        #gameCanvas {
          height: 100vh;
          height: -webkit-fill-available;
          width: auto;
          max-width: 100vw;
        }
        
        /* For iOS with safe areas */
        @supports (padding: max(0px)) {
          #gameContainer {
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
          }
        }
      }
      
      /* Portrait orientation - show warning */
      @media screen and (orientation: portrait) {
        #gameCanvas {
          display: none;
        }
        
        #rotateMessage {
          display: flex !important;
        }
      }
      
      #rotateMessage {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a1a2e;
        color: white;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        text-align: center;
        padding: 20px;
      }
      
      #rotateMessage svg {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
        animation: rotate 2s infinite ease-in-out;
      }
      
      @keyframes rotate {
        0%, 100% { transform: rotate(0deg); }
        50% { transform: rotate(90deg); }
      }
      
      #loadingBar {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      }
      
      #progressBar {
        width: 200px;
        height: 4px;
        background: rgba(255,255,255,0.1);
        border-radius: 2px;
        overflow: hidden;
        margin: 10px auto;
      }
      
      #progressBarFill {
        height: 100%;
        background: #667eea;
        width: 0%;
        transition: width 0.3s;
      }
      
      /* iOS PWA specific */
      @media (display-mode: standalone) {
        body {
          height: 100vh;
          height: 100%;
        }
      }
      
      /* Hide on desktop */
      @media (min-width: 1024px) {
        #rotateMessage {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div id="gameContainer">
      <canvas id="gameCanvas" tabindex="-1"></canvas>
      
      <div id="loadingBar">
        <div>Loading...</div>
        <div id="progressBar">
          <div id="progressBarFill"></div>
        </div>
        <div id="progressText">0%</div>
      </div>
    </div>
    
    <div id="rotateMessage">
      <svg viewBox="0 0 100 100">
        <rect x="35" y="20" width="30" height="60" rx="5" fill="none" stroke="white" stroke-width="3"/>
        <circle cx="50" cy="70" r="3" fill="white"/>
        <path d="M 70 50 L 80 40 L 80 60 Z" fill="white"/>
      </svg>
      <h2>Please Rotate Your Device</h2>
      <p>This game is best played in landscape mode</p>
    </div>
    
    <script>
      // iOS viewport fix
      function fixViewport() {
        const vh = window.innerHeight;
        const vw = window.innerWidth;
        
        // Set actual viewport dimensions
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        document.documentElement.style.setProperty('--vw', `${vw}px`);
        
        const canvas = document.getElementById('gameCanvas');
        const container = document.getElementById('gameContainer');
        
        if (vw > vh) {
          // Landscape mode
          const aspectRatio = 16 / 9;
          let canvasHeight = vh;
          let canvasWidth = vh * aspectRatio;
          
          // If calculated width is too wide, fit by width instead
          if (canvasWidth > vw) {
            canvasWidth = vw;
            canvasHeight = vw / aspectRatio;
          }
          
          // Apply dimensions
          canvas.style.width = `${canvasWidth}px`;
          canvas.style.height = `${canvasHeight}px`;
          
          // Ensure Unity renders at correct resolution
          canvas.width = canvasWidth;
          canvas.height = canvasHeight;
        }
      }
      
      // Fix viewport on various events
      window.addEventListener('load', fixViewport);
      window.addEventListener('resize', fixViewport);
      window.addEventListener('orientationchange', () => {
        setTimeout(fixViewport, 100);
      });
      
      // Prevent bounce scrolling on iOS
      document.body.addEventListener('touchmove', function(e) {
        e.preventDefault();
      }, { passive: false });
      
      // Hide address bar on scroll
      window.addEventListener('load', function() {
        setTimeout(function() {
          window.scrollTo(0, 1);
        }, 100);
      });
      
      // Unity WebGL loader
      const buildUrl = "Build";
      const loaderUrl = buildUrl + "/{{{ LOADER_FILENAME }}}";
      const config = {
        dataUrl: buildUrl + "/{{{ DATA_FILENAME }}}",
        frameworkUrl: buildUrl + "/{{{ FRAMEWORK_FILENAME }}}",
        codeUrl: buildUrl + "/{{{ CODE_FILENAME }}}",
#if MEMORY_FILENAME
        memoryUrl: buildUrl + "/{{{ MEMORY_FILENAME }}}",
#endif
#if SYMBOLS_FILENAME
        symbolsUrl: buildUrl + "/{{{ SYMBOLS_FILENAME }}}",
#endif
        streamingAssetsUrl: "StreamingAssets",
        companyName: "{{{ COMPANY_NAME }}}",
        productName: "{{{ PRODUCT_NAME }}}",
        productVersion: "{{{ PRODUCT_VERSION }}}",
        matchWebGLToCanvasSize: false, // Disable automatic sizing
      };

      const canvas = document.querySelector("#gameCanvas");
      const loadingBar = document.querySelector("#loadingBar");
      const progressBarFill = document.querySelector("#progressBarFill");
      const progressText = document.querySelector("#progressText");

      const script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          const percentage = Math.round(100 * progress);
          progressBarFill.style.width = percentage + "%";
          progressText.textContent = percentage + "%";
        }).then((unityInstance) => {
          loadingBar.style.display = "none";
          window.gameInstance = unityInstance;
          
          // Final viewport adjustment after Unity loads
          fixViewport();
        }).catch((message) => {
          alert(message);
        });
      };
      document.body.appendChild(script);
      
      // Service Worker for PWA
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js');
      }
      
      // iOS Standalone (PWA) detection
      if (window.navigator.standalone === true) {
        console.log('Running as iOS PWA');
        document.body.classList.add('ios-pwa');
      }
      
      // Attempt fullscreen on first touch (for Android)
      document.addEventListener('touchstart', function() {
        if (document.documentElement.requestFullscreen && !document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(() => {});
        }
      }, { once: true });
      
      // Visibility handling
      document.addEventListener('visibilitychange', () => {
        if (window.gameInstance) {
          if (document.hidden) {
            window.gameInstance.SendMessage('SlotController', 'OnApplicationPause', 'true');
          } else {
            window.gameInstance.SendMessage('SlotController', 'OnApplicationPause', 'false');
          }
        }
      });
    </script>
  </body>
</html>